# ReqTransCore

## 模块功能

ReqTransCore负责处理本地通信操作的发起部分。该模块由四级流水级模块和通信队列模块组成通过通过接口与OoOStation、CQMgt等外部通信队列模块交互

* ReqTransCore\_Thread\_1：第一个流水级从Sub-WQE中提取QPN（Queue Pair Number），向OoOStation发起上下文查询请求；
* ReqTransCore\_Thread\_2：第二个流水级解析Sub-WQE，发送内存区域（MR）请求，管理完成队列CQ和事件队列EQ；
* ReqTransCore\_Thread\_3：第三个流水级负责处理MR响应，生成DMA Gather请求，从主机内存读取待发送的数据；
* ReqTransCore\_Thread\_4：第四个流水级生成网络包元数据，管理Payload缓冲区，生成CQE/Event，并注入到TransportSubsystem传输子系统。
* SyncFIFO\_Template：提供可配置的同步FIFO供第三级流水线和第四级流水线通信。

## 模块架构

<figure><img src="../../../.gitbook/assets/ReqTransCore .png" alt=""><figcaption></figcaption></figure>

## 模块接口

<table><thead><tr><th width="191">接口名称</th><th width="87">方向</th><th width="247">位宽</th><th width="151">对接模块</th><th width="247">说明</th></tr></thead><tbody><tr><td>clk</td><td>input</td><td>1</td><td>全局时钟</td><td>全局时钟信号</td></tr><tr><td>rst</td><td>input</td><td>1</td><td>全局复位</td><td>全局复位信号（高电平有效）</td></tr><tr><td>sub_wqe_valid</td><td>input</td><td>1</td><td>WQEParser</td><td>WQE 有效信号</td></tr><tr><td>sub_wqe_meta</td><td>input</td><td>WQE_META_WIDTH = 576</td><td>WQEParser</td><td>WQE 元数据</td></tr><tr><td>sub_wqe_ready</td><td>output</td><td>1</td><td>WQEParser</td><td>本模块准备好接收 WQE</td></tr><tr><td>fetch_cxt_ingress_valid</td><td>output</td><td>1</td><td>OoOStation</td><td>上下文请求有效</td></tr><tr><td>fetch_cxt_ingress_head</td><td>output</td><td>TX_REQ_OOO_CXT_INGRESS_HEAD_WIDTH = 672</td><td>OoOStation</td><td>上下文请求头部（QP+CQ+EQ 上下文 + 通用头）</td></tr><tr><td>fetch_cxt_ingress_data</td><td>output</td><td>TX_REQ_OOO_CXT_INGRESS_DATA_WIDTH = 576</td><td>OoOStation</td><td>上下文请求数据（原始 WQE）</td></tr><tr><td>fetch_cxt_ingress_start</td><td>output</td><td>1</td><td>OoOStation</td><td>上下文请求包起始</td></tr><tr><td>fetch_cxt_ingress_last</td><td>output</td><td>1</td><td>OoOStation</td><td>上下文请求包结束</td></tr><tr><td>fetch_cxt_ingress_ready</td><td>input</td><td>1</td><td>OoOStation</td><td>OoOStation 准备好接收上下文请求</td></tr><tr><td>fetch_cxt_egress_valid</td><td>input</td><td>1</td><td>OoOStation</td><td>上下文响应有效</td></tr><tr><td>fetch_cxt_egress_head</td><td>input</td><td>TX_REQ_OOO_CXT_EGRESS_HEAD_WIDTH = 672</td><td>OoOStation</td><td>上下文响应头部</td></tr><tr><td>fetch_cxt_egress_data</td><td>input</td><td>TX_REQ_OOO_CXT_EGRESS_DATA_WIDTH = 576</td><td>OoOStation</td><td>上下文响应数据（原始 WQE）</td></tr><tr><td>fetch_cxt_egress_start</td><td>input</td><td>1</td><td>OoOStation</td><td>上下文响应包起始</td></tr><tr><td>fetch_cxt_egress_last</td><td>input</td><td>1</td><td>OoOStation</td><td>上下文响应包结束</td></tr><tr><td>fetch_cxt_egress_ready</td><td>output</td><td>1</td><td>OoOStation</td><td>本模块准备好接收上下文响应</td></tr><tr><td>fetch_mr_ingress_valid</td><td>output</td><td>1</td><td>OoOStation</td><td>MR 请求有效</td></tr><tr><td>fetch_mr_ingress_head</td><td>output</td><td>TX_REQ_OOO_MR_INGRESS_HEAD_WIDTH = 224</td><td>OoOStation</td><td>MR 请求头部（长度+地址+PD+flags+通用头）</td></tr><tr><td>fetch_mr_ingress_data</td><td>output</td><td>TX_REQ_OOO_MR_INGRESS_DATA_WIDTH = 576</td><td>OoOStation</td><td>MR 请求数据（WQE 字段 + opcode）</td></tr><tr><td>fetch_mr_ingress_start</td><td>output</td><td>1</td><td>OoOStation</td><td>MR 请求包起始</td></tr><tr><td>fetch_mr_ingress_last</td><td>output</td><td>1</td><td>OoOStation</td><td>MR 请求包结束</td></tr><tr><td>fetch_mr_ingress_ready</td><td>input</td><td>1</td><td>OoOStation</td><td>OoOStation 准备好接收 MR 请求</td></tr><tr><td>fetch_mr_egress_valid</td><td>input</td><td>1</td><td>OoOStation</td><td>MR 响应有效</td></tr><tr><td>fetch_mr_egress_head</td><td>input</td><td>TX_REQ_OOO_MR_EGRESS_HEAD_WIDTH = 224</td><td>OoOStation</td><td>MR 响应头部（物理地址 + 通用头）</td></tr><tr><td>fetch_mr_egress_data</td><td>input</td><td>TX_REQ_OOO_MR_EGRESS_DATA_WIDTH = 576</td><td>OoOStation</td><td>MR 响应数据（原始 WQE）</td></tr><tr><td>fetch_mr_egress_start</td><td>input</td><td>1</td><td>OoOStation</td><td>MR 响应包起始</td></tr><tr><td>fetch_mr_egress_last</td><td>input</td><td>1</td><td>OoOStation</td><td>MR 响应包结束</td></tr><tr><td>fetch_mr_egress_ready</td><td>output</td><td>1</td><td>OoOStation</td><td>本模块准备好接收 MR 响应</td></tr><tr><td>cq_req_valid</td><td>output</td><td>1</td><td>CompletionQueueMgt</td><td>CQ 请求有效</td></tr><tr><td>cq_req_head</td><td>output</td><td>CQ_REQ_HEAD_WIDTH = 64</td><td>CompletionQueueMgt</td><td>CQ 请求头部（CQ 长度 + CQN）</td></tr><tr><td>cq_req_ready</td><td>input</td><td>1</td><td>CompletionQueueMgt</td><td>CQ 准备好接收请求</td></tr><tr><td>cq_resp_valid</td><td>input</td><td>1</td><td>CompletionQueueMgt</td><td>CQ 响应有效</td></tr><tr><td>cq_resp_head</td><td>input</td><td>CQ_RESP_HEAD_WIDTH = 96</td><td>CompletionQueueMgt</td><td>CQ 响应头部（CQ 基地址）</td></tr><tr><td>cq_resp_ready</td><td>output</td><td>1</td><td>CompletionQueueMgt</td><td>本模块准备好接收 CQ 响应</td></tr><tr><td>eq_req_valid</td><td>output</td><td>1</td><td>EventQueueMgt</td><td>EQ 请求有效</td></tr><tr><td>eq_req_head</td><td>output</td><td>EQ_REQ_HEAD_WIDTH = 64</td><td>EventQueueMgt</td><td>EQ 请求头部（EQ 长度 + EQN）</td></tr><tr><td>eq_req_ready</td><td>input</td><td>1</td><td>EventQueueMgt</td><td>EQ 准备好接收请求</td></tr><tr><td>eq_resp_valid</td><td>input</td><td>1</td><td>EventQueueMgt</td><td>EQ 响应有效</td></tr><tr><td>eq_resp_head</td><td>input</td><td>EQ_RESP_HEAD_WIDTH = 96</td><td>EventQueueMgt</td><td>EQ 响应头部（EQ 基地址）</td></tr><tr><td>eq_resp_ready</td><td>output</td><td>1</td><td>EventQueueMgt</td><td>本模块准备好接收 EQ 响应</td></tr><tr><td>gather_req_wr_en</td><td>output</td><td>1</td><td>Gather 模块</td><td>DMA 读请求写使能</td></tr><tr><td>gather_req_din</td><td>output</td><td>DMA_LENGTH_WIDTH * 2 + DMA_ADDR_WIDTH = 128</td><td>Gather 模块</td><td>DMA 读请求数据（packet_len, size, phy_addr）</td></tr><tr><td>gather_req_prog_full</td><td>input</td><td>1</td><td>Gather 模块</td><td>Gather FIFO 已满（流控）</td></tr><tr><td>net_data_rd_en</td><td>output</td><td>1</td><td>GatherData</td><td>请求 payload 数据</td></tr><tr><td>net_data_dout</td><td>input</td><td>DMA_DATA_WIDTH = 512</td><td>GatherData</td><td>payload 数据（64 字节分片）</td></tr><tr><td>net_data_empty</td><td>input</td><td>1</td><td>GatherData</td><td>GatherData FIFO 为空</td></tr><tr><td>scatter_req_wen</td><td>output</td><td>1</td><td>Scatter 模块</td><td>Scatter 请求写使能</td></tr><tr><td>scatter_req_din</td><td>output</td><td>DMA_LENGTH_WIDTH * 2 + DMA_ADDR_WIDTH = 128</td><td>Scatter 模块</td><td>Scatter 请求（CQE 长度 + 地址）</td></tr><tr><td>scatter_req_prog_full</td><td>input</td><td>1</td><td>Scatter 模块</td><td>Scatter 请求 FIFO 已满</td></tr><tr><td>scatter_data_wen</td><td>output</td><td>1</td><td>Scatter 模块</td><td>Scatter 数据写使能</td></tr><tr><td>scatter_data_din</td><td>output</td><td>DMA_DATA_WIDTH = 512</td><td>Scatter 模块</td><td>CQE/Event 数据内容</td></tr><tr><td>scatter_data_prog_full</td><td>input</td><td>1</td><td>Scatter 模块</td><td>Scatter 数据 FIFO 已满</td></tr><tr><td>enqueue_req_valid</td><td>output</td><td>1</td><td>RC WQE Buffer</td><td>RC WQE 入队请求有效</td></tr><tr><td>enqueue_req_head</td><td>output</td><td>MAX_QP_NUM_LOG + MAX_DMQ_SLOT_NUM_LOG = 23</td><td>RC WQE Buffer</td><td>WQE 队列头（valid + QPN）</td></tr><tr><td>enqueue_req_data</td><td>output</td><td>RC_WQE_BUFFER_SLOT_WIDTH = 256</td><td>RC WQE Buffer</td><td>WQE 数据（精简字段）</td></tr><tr><td>enqueue_req_start</td><td>output</td><td>1</td><td>RC WQE Buffer</td><td>WQE 包起始</td></tr><tr><td>enqueue_req_last</td><td>output</td><td>1</td><td>RC WQE Buffer</td><td>WQE 包结束</td></tr><tr><td>enqueue_req_ready</td><td>input</td><td>1</td><td>RC WQE Buffer</td><td>RC WQE Buffer 准备好接收</td></tr><tr><td>insert_req_valid</td><td>output</td><td>1</td><td>Packet Buffer</td><td>Payload 插入请求有效</td></tr><tr><td>insert_req_start</td><td>output</td><td>1</td><td>Packet Buffer</td><td>Payload 第一片标志</td></tr><tr><td>insert_req_last</td><td>output</td><td>1</td><td>Packet Buffer</td><td>Payload 最后一片标志</td></tr><tr><td>insert_req_head</td><td>output</td><td>MAX_DB_SLOT_NUM_LOG = 16</td><td>Packet Buffer</td><td>Payload 总分片数</td></tr><tr><td>insert_req_data</td><td>output</td><td>PACKET_BUFFER_SLOT_WIDTH = 512</td><td>Packet Buffer</td><td>Payload 数据（64 字节分片）</td></tr><tr><td>insert_req_ready</td><td>input</td><td>1</td><td>Packet Buffer</td><td>Packet Buffer 准备好接收</td></tr><tr><td>insert_resp_valid</td><td>input</td><td>1</td><td>Packet Buffer</td><td>Packet Buffer 插入响应有效</td></tr><tr><td>insert_resp_data</td><td>input</td><td>MAX_DB_SLOT_NUM_LOG = 16</td><td>Packet Buffer</td><td>分配的 payload buffer 起始地址</td></tr><tr><td>egress_pkt_valid</td><td>output</td><td>1</td><td>TransportSubsystem</td><td>网络包有效</td></tr><tr><td>egress_pkt_head</td><td>output</td><td>PKT_META_BUS_WIDTH = 488</td><td>TransportSubsystem</td><td>网络包元数据（含 payload 地址、QPN、opcode 等）</td></tr><tr><td>egress_pkt_ready</td><td>input</td><td>1</td><td>TransportSubsystem</td><td>传输子系统准备好接收</td></tr></tbody></table>

