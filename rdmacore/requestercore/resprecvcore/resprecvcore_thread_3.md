# RespRecvCore\_Thread\_3

## 功能

* 接收 MR（Memory Region）响应：包含主机内存物理地址、页信息、权限状态。
* 根据操作类型执行不同任务：
  * 若为 RDMA Read Response：从 PacketBuffer 读取 payload 数据，通过 scatter-gather 写入主机内存（支持跨页）。
  * 若为 GEN\_CQE：构造完成队列条目（CQE），写入 CQ（Completion Queue）。
  * 若为 GEN\_EVENT：预留事件和中断生成。
* 释放 NIC 内部资源：向 PacketBuffer 发送删除请求，释放已处理的包 slot。

## 接口

<table><thead><tr><th width="251">信号名称</th><th width="87">方向</th><th width="87">位宽</th><th width="103">对接模块</th><th width="247">说明</th></tr></thead><tbody><tr><td>clk</td><td>input</td><td>1</td><td>全局时钟</td><td>上升沿驱动</td></tr><tr><td>rst</td><td>input</td><td>1</td><td>全局复位</td><td>同步高有效复位</td></tr><tr><td>fetch_mr_egress_valid</td><td>input</td><td>1</td><td>OoOStation</td><td>MR 响应有效</td></tr><tr><td>fetch_mr_egress_head</td><td>input</td><td>256</td><td>OoOStation</td><td>MR 响应头（含物理地址、页长度、有效性）</td></tr><tr><td>fetch_mr_egress_data</td><td>input</td><td>488</td><td>OoOStation</td><td>MR 附带数据（含包地址、opcode、QP 号等）</td></tr><tr><td>fetch_mr_egress_start</td><td>input</td><td>1</td><td>OoOStation</td><td>分段起始（本设计恒为 1）</td></tr><tr><td>fetch_mr_egress_last</td><td>input</td><td>1</td><td>OoOStation</td><td>分段结束（本设计恒为 1）</td></tr><tr><td>fetch_mr_egress_ready</td><td>output</td><td>1</td><td>OoOStation</td><td>本模块就绪接收 MR</td></tr><tr><td>scatter_req_wen</td><td>output</td><td>1</td><td>DMA 读写模块</td><td>地址/长度请求写使能</td></tr><tr><td>scatter_req_din</td><td>output</td><td>128</td><td>DMA 读写模块</td><td>DMA 请求接口</td></tr><tr><td>scatter_req_prog_full</td><td>input</td><td>1</td><td>DMA 读写模块</td><td>请求 FIFO 满标志</td></tr><tr><td>scatter_data_wen</td><td>output</td><td>1</td><td>DMA 读写模块</td><td>数据写使能</td></tr><tr><td>scatter_data_din</td><td>output</td><td>512</td><td>DMA 读写模块</td><td>数据内容</td></tr><tr><td>scatter_data_prog_full</td><td>input</td><td>1</td><td>DMA 读写模块</td><td>数据 FIFO 满标志</td></tr><tr><td>delete_req_valid</td><td>output</td><td>1</td><td>PacketBuffer</td><td>删除请求有效</td></tr><tr><td>delete_req_head</td><td>output</td><td>22</td><td>PacketBuffer</td><td>删除请求头</td></tr><tr><td>delete_req_ready</td><td>input</td><td>1</td><td>PacketBuffer</td><td>PacketBuffer 就绪</td></tr><tr><td>delete_resp_valid</td><td>input</td><td>1</td><td>PacketBuffer</td><td>删除响应有效</td></tr><tr><td>delete_resp_start</td><td>input</td><td>1</td><td>PacketBuffer</td><td>分段起始</td></tr><tr><td>delete_resp_last</td><td>input</td><td>1</td><td>PacketBuffer</td><td>分段结束</td></tr><tr><td>delete_resp_data</td><td>input</td><td>512</td><td>PacketBuffer</td><td>被删除的包数据</td></tr><tr><td>delete_resp_ready</td><td>output</td><td>1</td><td>PacketBuffer</td><td>本模块就绪接收删除响应</td></tr></tbody></table>

## 状态机设计

### 状态说明

<table><thead><tr><th width="199">状态名</th><th width="87">编码</th><th width="404.7144775390625">说明</th></tr></thead><tbody><tr><td>IDLE_s</td><td>4'd1</td><td>空闲态：等待 MR 响应</td></tr><tr><td>JUDGE_s</td><td>4'd2</td><td>判定态：根据 opcode 决定操作类型</td></tr><tr><td>GET_PAYLOAD_s</td><td>4'd3</td><td>获取 payload：向 PacketBuffer 发 delete 请求</td></tr><tr><td>DMA_PAYLOAD_PAGE_0_REQ_s</td><td>4'd4</td><td>发第 0 页地址请求</td></tr><tr><td>DMA_PAYLOAD_PAGE_1_REQ_s</td><td>4'd5</td><td>发第 1 页地址请求（跨页时）</td></tr><tr><td>DMA_PAYLOAD_DATA_s</td><td>4'd6</td><td>发 payload 数据</td></tr><tr><td>DMA_CQE_s</td><td>4'd7</td><td>写 CQE</td></tr><tr><td>DMA_EVENT_s</td><td>4'd8</td><td>写 Event</td></tr><tr><td>DMA_INT_s</td><td>4'd9</td><td>发中断</td></tr></tbody></table>

### 状态转移

<table><thead><tr><th width="199">现态</th><th width="199">次态</th><th width="247">转移条件</th><th width="235">说明</th></tr></thead><tbody><tr><td>IDLE_s</td><td>JUDGE_s</td><td>fetch_mr_egress_valid == 1</td><td>收到 MR 响应，开始处理</td></tr><tr><td>IDLE_s</td><td>IDLE_s</td><td>fetch_mr_egress_valid == 0</td><td>无 MR，保持空闲</td></tr><tr><td>JUDGE_s</td><td>GET_PAYLOAD_s</td><td>meta_net_opcode 为 RDMA_READ_REQUEST_*</td><td>需写 payload 数据</td></tr><tr><td>JUDGE_s</td><td>DMA_CQE_s</td><td>meta_net_opcode == GEN_CQE</td><td>需生成 CQE</td></tr><tr><td>JUDGE_s</td><td>DMA_EVENT_s</td><td>meta_net_opcode == GEN_EVENT</td><td>需生成 Event</td></tr><tr><td>JUDGE_s</td><td>IDLE_s</td><td>其他 opcode</td><td>未知操作，直接结束</td></tr><tr><td>GET_PAYLOAD_s</td><td>DMA_PAYLOAD_PAGE_0_REQ_s</td><td>delete_req_valid &#x26;&#x26; delete_req_ready</td><td>delete 请求被接收</td></tr><tr><td>GET_PAYLOAD_s</td><td>GET_PAYLOAD_s</td><td>!(delete_req_valid &#x26;&#x26; delete_req_ready)</td><td>等待 PacketBuffer 就绪</td></tr><tr><td>DMA_PAYLOAD_PAGE_0_REQ_s</td><td>DMA_PAYLOAD_PAGE_1_REQ_s</td><td>!scatter_req_prog_full &#x26;&#x26; mr_resp_valid_1</td><td>FIFO 未满且跨两页</td></tr><tr><td>DMA_PAYLOAD_PAGE_0_REQ_s</td><td>DMA_PAYLOAD_DATA_s</td><td>!scatter_req_prog_full &#x26;&#x26; !mr_resp_valid_1</td><td>FIFO 未满且单页</td></tr><tr><td>DMA_PAYLOAD_PAGE_0_REQ_s</td><td>DMA_PAYLOAD_PAGE_0_REQ_s</td><td>scatter_req_prog_full</td><td>FIFO 满，继续等待</td></tr><tr><td>DMA_PAYLOAD_PAGE_1_REQ_s</td><td>DMA_PAYLOAD_DATA_s</td><td>!scatter_req_prog_full</td><td>FIFO 未满</td></tr><tr><td>DMA_PAYLOAD_PAGE_1_REQ_s</td><td>DMA_PAYLOAD_PAGE_1_REQ_s</td><td>scatter_req_prog_full</td><td>FIFO 满，继续等待</td></tr><tr><td>DMA_PAYLOAD_DATA_s</td><td>IDLE_s</td><td>delete_resp_last &#x26;&#x26; !scatter_data_prog_full</td><td>最后一拍数据且 FIFO 未满</td></tr><tr><td>DMA_PAYLOAD_DATA_s</td><td>DMA_PAYLOAD_DATA_s</td><td>!(delete_resp_last &#x26;&#x26; !scatter_data_prog_full)</td><td>继续发送数据或等待 FIFO</td></tr><tr><td>DMA_CQE_s</td><td>IDLE_s</td><td>!scatter_req_prog_full &#x26;&#x26; !scatter_data_prog_full</td><td>地址和数据 FIFO 均未满</td></tr><tr><td>DMA_CQE_s</td><td>DMA_CQE_s</td><td>!(!scatter_req_prog_full &#x26;&#x26; !scatter_data_prog_full)</td><td>等待 FIFO</td></tr><tr><td>DMA_EVENT_s</td><td>DMA_INT_s</td><td>!scatter_req_prog_full &#x26;&#x26; !scatter_data_prog_full</td><td>FIFO 未满</td></tr><tr><td>DMA_EVENT_s</td><td>DMA_EVENT_s</td><td>!(!scatter_req_prog_full &#x26;&#x26; !scatter_data_prog_full)</td><td>等待 FIFO</td></tr><tr><td>DMA_INT_s</td><td>IDLE_s</td><td>!scatter_req_prog_full &#x26;&#x26; !scatter_data_prog_full</td><td>FIFO 未满</td></tr><tr><td>DMA_INT_s</td><td>DMA_INT_s</td><td>!(!scatter_req_prog_full &#x26;&#x26; !scatter_data_prog_full)</td><td>等待 FIFO</td></tr></tbody></table>

### 状态转移图

<figure><img src="../../../.gitbook/assets/RespRecvCore_Thread_3 (1).png" alt=""><figcaption></figcaption></figure>
