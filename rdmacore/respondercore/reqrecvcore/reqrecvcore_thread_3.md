# ReqRecvCore\_Thread\_3

## 模块功能

ReqRecvCore\_Thread\_3 是 RDMA 接收路径中 ReqRecvCore 模块的第三阶段处理单元，其核心功能包括：

* 接收来自 OoOStation 的 MR 权限验证结果与操作元数据；
* 从 Packet Buffer 读取入向包 payload；
* 根据操作类型（SEND / RDMA\_WRITE / RDMA\_READ / CQE / EQE / ACK）发起 Scatter DMA Write，写入数据到主机内存或 Gather DMA Read，读取本地数据用于响应；
* 通过 MetaCollectionBuffer（实例化DMQ） 聚合多段 SEND 的 MR 结果，确保原子性写入；
* 生成响应元数据（用于 RDMA\_READ 响应、ACK、CQE、EQE 等），并通过 net\_resp 接口传递给 RespTransCore；
* 维护每个 QP 的累计接收字节数，用于 CQE 填充。

## 模块接口

<table><thead><tr><th width="183">接口</th><th width="95">输入/输出</th><th width="87">位宽</th><th width="119">对接模块</th><th width="247">说明</th></tr></thead><tbody><tr><td>clk</td><td>input</td><td>1</td><td>全局时钟</td><td>系统主时钟</td></tr><tr><td>rst</td><td>input</td><td>1</td><td>全局复位</td><td>高有效异步复位</td></tr><tr><td>fetch_mr_egress_valid</td><td>input</td><td>1</td><td>OoOStation</td><td>MR 响应有效信号</td></tr><tr><td>fetch_mr_egress_head</td><td>input</td><td>224</td><td>OoOStation</td><td>MR 响应头（含物理地址、权限状态、valid 位）</td></tr><tr><td>fetch_mr_egress_data</td><td>input</td><td>256</td><td>OoOStation</td><td>MR响应数据（包元数据）</td></tr><tr><td>fetch_mr_egress_start</td><td>input</td><td>1</td><td>OoOStation</td><td>MR 响应事务起始</td></tr><tr><td>fetch_mr_egress_last</td><td>input</td><td>1</td><td>OoOStation</td><td>MR 响应事务结束</td></tr><tr><td>fetch_mr_egress_ready</td><td>output</td><td>1</td><td>OoOStation</td><td>本模块接收就绪信号</td></tr><tr><td>delete_req_valid</td><td>output</td><td>1</td><td>Packet Buffer</td><td>请求读取包 payload</td></tr><tr><td>delete_req_head</td><td>output</td><td>32</td><td>Packet Buffer</td><td>请求头（含起始地址/槽位数）</td></tr><tr><td>delete_req_ready</td><td>input</td><td>1</td><td>Packet Buffer</td><td>Packet Buffer 就绪信号</td></tr><tr><td>delete_resp_valid</td><td>input</td><td>1</td><td>Packet Buffer</td><td>payload 读取有效</td></tr><tr><td>delete_resp_start</td><td>input</td><td>1</td><td>Packet Buffer</td><td>payload 事务起始</td></tr><tr><td>delete_resp_last</td><td>input</td><td>1</td><td>Packet Buffer</td><td>payload 事务结束</td></tr><tr><td>delete_resp_data</td><td>input</td><td>512</td><td>Packet Buffer</td><td>payload 数据</td></tr><tr><td>delete_resp_ready</td><td>output</td><td>1</td><td>Packet Buffer</td><td>本模块消费就绪信号</td></tr><tr><td>scatter_req_wr_en</td><td>output</td><td>1</td><td>DMA Controller</td><td>Scatter DMA 写请求使能</td></tr><tr><td>scatter_req_din</td><td>output</td><td>160</td><td>DMA Controller</td><td>Scatter 请求数据</td></tr><tr><td>scatter_req_prog_full</td><td>input</td><td>1</td><td>DMA Controller</td><td>Scatter 请求 FIFO 即将满</td></tr><tr><td>scatter_data_wr_en</td><td>output</td><td>1</td><td>DMA Controller</td><td>Scatter 数据写使能</td></tr><tr><td>scatter_data_din</td><td>output</td><td>512</td><td>DMA Controller</td><td>要写入的数据（payload 或 CQE）</td></tr><tr><td>scatter_data_prog_full</td><td>input</td><td>1</td><td>DMA Controller</td><td>Scatter 数据 FIFO 即将满</td></tr><tr><td>gather_req_wr_en</td><td>output</td><td>1</td><td>DMA Controller</td><td>Gather DMA 读请求使能</td></tr><tr><td>gather_req_din</td><td>output</td><td>160</td><td>DMA Controller</td><td>Gather 请求数据</td></tr><tr><td>gather_req_prog_full</td><td>input</td><td>1</td><td>DMA Controller</td><td>Gather 请求 FIFO 即将满</td></tr><tr><td>net_resp_wen</td><td>output</td><td>1</td><td>RespTransCore</td><td>响应元数据写使能</td></tr><tr><td>net_resp_din</td><td>output</td><td>512</td><td>RespTransCore</td><td>响应包元数据（目标 QP、opcode、地址等）</td></tr><tr><td>net_resp_prog_full</td><td>input</td><td>1</td><td>RespTransCore</td><td>FIFO 即将满</td></tr></tbody></table>

## 状态机设计

### 状态定义

<table><thead><tr><th width="183">状态名</th><th width="137">编码（5'b）</th><th width="389">说明</th></tr></thead><tbody><tr><td>IDLE_s</td><td>5'b00001</td><td>空闲状态：等待 MR 响应</td></tr><tr><td>JUDGE_s</td><td>5'b00010</td><td>判决状态：解析 opcode，决定后续路径</td></tr><tr><td>ENQUEUE_META_REQ_s</td><td>5'b00011</td><td>将 SEND 的 MR 响应入队 DMQ</td></tr><tr><td>DEQUEUE_META_REQ_s</td><td>5'b00100</td><td>请求从 DMQ 出队聚合元数据</td></tr><tr><td>DEQUEUE_META_RESP_s</td><td>5'b00101</td><td>接收 DMQ 出队响应</td></tr><tr><td>GET_SEND_PAYLOAD_s</td><td>5'b00110</td><td>请求 SEND 包 payload</td></tr><tr><td>GET_WRITE_PAYLOAD_s</td><td>5'b00111</td><td>请求 WRITE 包 payload</td></tr><tr><td>DMA_SEND_PAGE_0_REQ_s</td><td>5'b01000</td><td>发起 SEND 第 0 页 DMA 请求</td></tr><tr><td>DMA_SEND_PAGE_1_REQ_s</td><td>5'b01001</td><td>发起 SEND 第 1 页 DMA 请求</td></tr><tr><td>DMA_SEND_DATA_s</td><td>5'b01010</td><td>写入 SEND payload 数据</td></tr><tr><td>DMA_WRITE_PAGE_0_REQ_s</td><td>5'b01011</td><td>发起 WRITE 第 0 页 DMA 请求</td></tr><tr><td>DMA_WRITE_PAGE_1_REQ_s</td><td>5'b01100</td><td>发起 WRITE 第 1 页 DMA 请求</td></tr><tr><td>DMA_WRITE_DATA_s</td><td>5'b01101</td><td>写入 WRITE payload 数据</td></tr><tr><td>DMA_CQE_s</td><td>5'b01110</td><td>写入 CQE</td></tr><tr><td>DMA_EVENT_s</td><td>5'b01111</td><td>写入 EQE</td></tr><tr><td>DMA_INT_s</td><td>5'b10000</td><td>触发中断</td></tr><tr><td>DMA_READ_PAGE_0_REQ_s</td><td>5'b10001</td><td>发起 READ 第 0 页 DMA 请求</td></tr><tr><td>DMA_READ_PAGE_1_REQ_s</td><td>5'b10010</td><td>发起 READ 第 1 页 DMA 请求</td></tr><tr><td>GEN_RESP_s</td><td>5'b10011</td><td>生成响应元数据</td></tr></tbody></table>

### 状态转移表

<table><thead><tr><th width="183">现态</th><th width="183">次态</th><th width="444">转移条件</th><th width="247">中文说明</th><th data-type="image"></th></tr></thead><tbody><tr><td>IDLE_s</td><td>JUDGE_s</td><td>fetch_mr_egress_valid == 1</td><td>收到 MR 响应，进入操作码判决</td><td></td></tr><tr><td>IDLE_s</td><td>IDLE_s</td><td>fetch_mr_egress_valid == 0</td><td>无 MR 响应，保持空闲</td><td></td></tr><tr><td>JUDGE_s</td><td>ENQUEUE_META_REQ_s</td><td>PktHeader_net_opcode == `SEND_FIRST || PktHeader_net_opcode == `SEND_MIDDLE || PktHeader_net_opcode == `SEND_LAST || PktHeader_net_opcode == `SEND_ONLY || PktHeader_net_opcode == `SEND_LAST_WITH_IMM || PktHeader_net_opcode == `SEND_ONLY_WITH_IMM</td><td>SEND 操作，需入队 DMQ 聚合多段 MR</td><td></td></tr><tr><td>JUDGE_s</td><td>GET_WRITE_PAYLOAD_s</td><td>PktHeader_net_opcode == `RDMA_WRITE_FIRST || PktHeader_net_opcode == `RDMA_WRITE_MIDDLE || PktHeader_net_opcode == `RDMA_WRITE_LAST || PktHeader_net_opcode == `RDMA_WRITE_ONLY || PktHeader_net_opcode == `RDMA_WRITE_LAST_WITH_IMM || PktHeader_net_opcode == `RDMA_WRITE_ONLY_WITH_IMM</td><td>RDMA_WRITE 操作，直接请求 payload</td><td></td></tr><tr><td>JUDGE_s</td><td>DMA_READ_PAGE_0_REQ_s</td><td>PktHeader_net_opcode == `RDMA_READ_RESPONSE_FIRST || PktHeader_net_opcode == `RDMA_READ_RESPONSE_MIDDLE || PktHeader_net_opcode == `RDMA_READ_RESPONSE_LAST || PktHeader_net_opcode == `RDMA_READ_RESPONSE_ONLY</td><td>RDMA_READ 响应，发起 Gather Read</td><td></td></tr><tr><td>JUDGE_s</td><td>GEN_RESP_s</td><td>PktHeader_net_opcode == `ACKNOWLEDGE</td><td>生成 ACK 响应</td><td></td></tr><tr><td>JUDGE_s</td><td>DMA_CQE_s</td><td>PktHeader_net_opcode == `GEN_CQE</td><td>写入 CQE</td><td></td></tr><tr><td>JUDGE_s</td><td>DMA_EVENT_s</td><td>PktHeader_net_opcode == `GEN_EVENT</td><td>写入 EQE</td><td></td></tr><tr><td>JUDGE_s</td><td>DMA_INT_s</td><td>PktHeader_net_opcode == `GEN_INT</td><td>触发中断</td><td></td></tr><tr><td>JUDGE_s</td><td>IDLE_s</td><td>PktHeader_net_opcode != `SEND_FIRST &#x26;&#x26; PktHeader_net_opcode != `SEND_MIDDLE &#x26;&#x26; PktHeader_net_opcode != `SEND_LAST &#x26;&#x26; PktHeader_net_opcode != `SEND_ONLY &#x26;&#x26; PktHeader_net_opcode != `SEND_LAST_WITH_IMM &#x26;&#x26; PktHeader_net_opcode != `SEND_ONLY_WITH_IMM &#x26;&#x26; PktHeader_net_opcode != `RDMA_WRITE_FIRST &#x26;&#x26; PktHeader_net_opcode != `RDMA_WRITE_MIDDLE &#x26;&#x26; PktHeader_net_opcode != `RDMA_WRITE_LAST &#x26;&#x26; PktHeader_net_opcode != `RDMA_WRITE_ONLY &#x26;&#x26; PktHeader_net_opcode != `RDMA_WRITE_LAST_WITH_IMM &#x26;&#x26; PktHeader_net_opcode != `RDMA_WRITE_ONLY_WITH_IMM &#x26;&#x26; PktHeader_net_opcode != `RDMA_READ_RESPONSE_FIRST &#x26;&#x26; PktHeader_net_opcode != `RDMA_READ_RESPONSE_MIDDLE &#x26;&#x26; PktHeader_net_opcode != `RDMA_READ_RESPONSE_LAST &#x26;&#x26; PktHeader_net_opcode != `RDMA_READ_RESPONSE_ONLY &#x26;&#x26; PktHeader_net_opcode != `ACKNOWLEDGE &#x26;&#x26; PktHeader_net_opcode != `GEN_CQE &#x26;&#x26; PktHeader_net_opcode != `GEN_EVENT &#x26;&#x26; PktHeader_net_opcode != `GEN_INT</td><td>操作码不匹配，返回空闲</td><td></td></tr><tr><td>ENQUEUE_META_REQ_s</td><td>DEQUEUE_META_REQ_s</td><td>mcb_enqueue_req_valid == 1 &#x26;&#x26; mcb_enqueue_req_ready == 1 &#x26;&#x26; PktHeader_tail_indicator == `TAIL_FLAG</td><td>当前 SEND 段为尾段，开始出队聚合</td><td></td></tr><tr><td>ENQUEUE_META_REQ_s</td><td>IDLE_s</td><td>mcb_enqueue_req_valid == 1 &#x26;&#x26; mcb_enqueue_req_ready == 1 &#x26;&#x26; PktHeader_tail_indicator != `TAIL_FLAG</td><td>非尾段，完成入队，等待下一段</td><td></td></tr><tr><td>ENQUEUE_META_REQ_s</td><td>ENQUEUE_META_REQ_s</td><td>mcb_enqueue_req_valid == 0 || mcb_enqueue_req_ready == 0</td><td>等待 DMQ 就绪</td><td></td></tr><tr><td>DEQUEUE_META_REQ_s</td><td>DEQUEUE_META_RESP_s</td><td>mcb_dequeue_req_valid == 1 &#x26;&#x26; mcb_dequeue_req_ready == 1</td><td>DMQ 出队请求被接受</td><td></td></tr><tr><td>DEQUEUE_META_REQ_s</td><td>DEQUEUE_META_REQ_s</td><td>mcb_dequeue_req_valid == 0 || mcb_dequeue_req_ready == 0</td><td>等待 DMQ 就绪</td><td></td></tr><tr><td>DEQUEUE_META_RESP_s</td><td>DMA_SEND_PAGE_0_REQ_s</td><td>mcb_dequeue_resp_valid == 1 &#x26;&#x26; mcb_dequeue_resp_ready == 1</td><td>收到聚合元数据，发起 DMA</td><td></td></tr><tr><td>DEQUEUE_META_RESP_s</td><td>DEQUEUE_META_RESP_s</td><td>mcb_dequeue_resp_valid == 0 || mcb_dequeue_resp_ready == 0</td><td>等待 DMQ 响应</td><td></td></tr><tr><td>DMA_SEND_PAGE_0_REQ_s</td><td>DMA_SEND_PAGE_1_REQ_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; mcb_mr_valid_1 == `PAGE_VALID</td><td>第 1 页有效，继续请求</td><td></td></tr><tr><td>DMA_SEND_PAGE_0_REQ_s</td><td>GET_SEND_PAYLOAD_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; mcb_tail_indicator == `TAIL_FLAG &#x26;&#x26; mcb_mr_valid_1 != `PAGE_VALID</td><td>无第 1 页且为尾段，请求 payload</td><td></td></tr><tr><td>DMA_SEND_PAGE_0_REQ_s</td><td>DEQUEUE_META_REQ_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; mcb_tail_indicator != `TAIL_FLAG &#x26;&#x26; mcb_mr_valid_1 != `PAGE_VALID</td><td>继续出队下一段</td><td></td></tr><tr><td>DMA_SEND_PAGE_0_REQ_s</td><td>DMA_SEND_PAGE_0_REQ_s</td><td>scatter_req_prog_full == 1</td><td>FIFO 满，等待</td><td></td></tr><tr><td>DMA_SEND_PAGE_1_REQ_s</td><td>GET_SEND_PAYLOAD_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; mcb_tail_indicator == `TAIL_FLAG</td><td>尾段，请求 payload</td><td></td></tr><tr><td>DMA_SEND_PAGE_1_REQ_s</td><td>DEQUEUE_META_REQ_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; mcb_tail_indicator != `TAIL_FLAG</td><td>继续出队</td><td></td></tr><tr><td>DMA_SEND_PAGE_1_REQ_s</td><td>DMA_SEND_PAGE_1_REQ_s</td><td>scatter_req_prog_full == 1</td><td>等待 FIFO</td><td></td></tr><tr><td>GET_SEND_PAYLOAD_s</td><td>DMA_SEND_DATA_s</td><td>delete_req_valid == 1 &#x26;&#x26; delete_req_ready == 1</td><td>payload 请求被接受</td><td></td></tr><tr><td>GET_SEND_PAYLOAD_s</td><td>GET_SEND_PAYLOAD_s</td><td>delete_req_valid == 0 || delete_req_ready == 0</td><td>等待 Packet Buffer</td><td></td></tr><tr><td>GET_WRITE_PAYLOAD_s</td><td>DMA_WRITE_PAGE_0_REQ_s</td><td>delete_req_valid == 1 &#x26;&#x26; delete_req_ready == 1</td><td>payload 请求被接受</td><td></td></tr><tr><td>GET_WRITE_PAYLOAD_s</td><td>GET_WRITE_PAYLOAD_s</td><td>delete_req_valid == 0 || delete_req_ready == 0</td><td>等待 Packet Buffer</td><td></td></tr><tr><td>DMA_SEND_DATA_s</td><td>IDLE_s</td><td>delete_resp_valid == 1 &#x26;&#x26; delete_resp_last == 1 &#x26;&#x26; scatter_data_prog_full == 0</td><td>payload 读取完成且 DMA FIFO 未满，返回空闲</td><td></td></tr><tr><td>DMA_SEND_DATA_s</td><td>DMA_SEND_DATA_s</td><td>delete_resp_valid == 0 || delete_resp_last == 0 || scatter_data_prog_full == 1</td><td>等待 payload 或 DMA FIFO</td><td></td></tr><tr><td>DMA_WRITE_PAGE_0_REQ_s</td><td>DMA_WRITE_PAGE_1_REQ_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; mr_resp_valid_1 == `PAGE_VALID</td><td>第 1 页有效</td><td></td></tr><tr><td>DMA_WRITE_PAGE_0_REQ_s</td><td>DMA_WRITE_DATA_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; mr_resp_valid_1 != `PAGE_VALID</td><td>直接写入数据</td><td></td></tr><tr><td>DMA_WRITE_PAGE_0_REQ_s</td><td>DMA_WRITE_PAGE_0_REQ_s</td><td>scatter_req_prog_full == 1</td><td>等待 FIFO</td><td></td></tr><tr><td>DMA_WRITE_PAGE_1_REQ_s</td><td>DMA_WRITE_DATA_s</td><td>scatter_req_prog_full == 0</td><td>发起第 1 页请求后进入数据写入</td><td></td></tr><tr><td>DMA_WRITE_PAGE_1_REQ_s</td><td>DMA_WRITE_PAGE_1_REQ_s</td><td>scatter_req_prog_full == 1</td><td>等待 FIFO</td><td></td></tr><tr><td>DMA_WRITE_DATA_s</td><td>IDLE_s</td><td>delete_resp_valid == 1 &#x26;&#x26; delete_resp_last == 1 &#x26;&#x26; scatter_data_prog_full == 0</td><td>完成，返回空闲</td><td></td></tr><tr><td>DMA_WRITE_DATA_s</td><td>DMA_WRITE_DATA_s</td><td>delete_resp_valid == 0 || delete_resp_last == 0 || scatter_data_prog_full == 1</td><td>等待</td><td></td></tr><tr><td>DMA_CQE_s</td><td>IDLE_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; scatter_data_prog_full == 0</td><td>CQE 写入完成</td><td></td></tr><tr><td>DMA_CQE_s</td><td>DMA_CQE_s</td><td>scatter_req_prog_full == 1 || scatter_data_prog_full == 1</td><td>等待 FIFO</td><td></td></tr><tr><td>DMA_EVENT_s</td><td>IDLE_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; scatter_data_prog_full == 0</td><td>EQE 写入完成</td><td></td></tr><tr><td>DMA_EVENT_s</td><td>DMA_EVENT_s</td><td>scatter_req_prog_full == 1 || scatter_data_prog_full == 1</td><td>等待 FIFO</td><td></td></tr><tr><td>DMA_INT_s</td><td>IDLE_s</td><td>scatter_req_prog_full == 0 &#x26;&#x26; scatter_data_prog_full == 0</td><td>中断触发完成</td><td></td></tr><tr><td>DMA_INT_s</td><td>DMA_INT_s</td><td>scatter_req_prog_full == 1 || scatter_data_prog_full == 1</td><td>等待 FIFO</td><td></td></tr><tr><td>DMA_READ_PAGE_0_REQ_s</td><td>DMA_READ_PAGE_1_REQ_s</td><td>gather_req_prog_full == 0 &#x26;&#x26; mr_resp_valid_1 == `PAGE_VALID</td><td>第 1 页有效</td><td></td></tr><tr><td>DMA_READ_PAGE_0_REQ_s</td><td>GEN_RESP_s</td><td>gather_req_prog_full == 0 &#x26;&#x26; mr_resp_valid_1 != `PAGE_VALID</td><td>生成响应</td><td></td></tr><tr><td>DMA_READ_PAGE_0_REQ_s</td><td>DMA_READ_PAGE_0_REQ_s</td><td>gather_req_prog_full == 1</td><td>等待</td><td></td></tr><tr><td>DMA_READ_PAGE_1_REQ_s</td><td>GEN_RESP_s</td><td>gather_req_prog_full == 0</td><td>发起第 1 页后生成响应</td><td></td></tr><tr><td>DMA_READ_PAGE_1_REQ_s</td><td>DMA_READ_PAGE_1_REQ_s</td><td>gather_req_prog_full == 1</td><td>等待</td><td></td></tr><tr><td>GEN_RESP_s</td><td>IDLE_s</td><td>net_resp_prog_full == 0</td><td>响应生成完成</td><td></td></tr><tr><td>GEN_RESP_s</td><td>GEN_RESP_s</td><td>net_resp_prog_full == 1</td><td>等待 RespTransCore</td><td></td></tr><tr><td>default</td><td>IDLE_s</td><td>1</td><td>异常状态安全回退</td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr></tbody></table>

### 状态转移图

<figure><img src="../../../.gitbook/assets/ReqRecvCore_Thread_3  (3).png" alt=""><figcaption></figcaption></figure>
